<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff ‚Äì Gestion des Commandes</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background-color: #f9f7f0;
      color: #2c2c2c;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.8rem;
      color: #4a4a4a;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .stats-container {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      text-align: center;
      flex: 1;
      min-width: 200px;
    }

    .stat-card h3 {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #8d7b6e;
    }

    .action-btn {
      background: #2e5a4d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      margin-left: 10px;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .tab-btn {
      padding: 8px 20px;
      background: #e5d9c5;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .tab-btn.active, .tab-btn:hover {
      background: #c8b69c;
    }

    .search-bar input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 16px;
    }

    .orders-container, .menu-list-container {
      flex: 1;
      overflow-y: auto;
      max-height: calc(100vh - 300px);
    }

    .order, .menu-item-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .order-header, .menu-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .order-items { margin: 12px 0; padding-left: 16px; }
    .order-item { margin-bottom: 6px; font-size: 0.95rem; }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-confirm { background: #4caf50; color: white; }
    .btn-delete { background: #f44336; color: white; }

    .menu-inputs {
      margin-top: 20px;
    }

    .menu-inputs input,
    .menu-inputs textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .add-btn {
      background: #2e5a4d;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
    }

    .url-input { margin-bottom: 12px; }

    .hidden { display: none; }

    /* Notification visuelle */
    #notificationToast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2e5a4d;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: none;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .stats-container {
        flex-direction: column;
      }
      .stat-card {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìã Dashboard Staff</h1>
  </header>

  <div class="stats-container">
    <div class="stat-card">
      <h3>Chiffre d'affaires aujourd'hui</h3>
      <div class="value" id="todaySales">0 MAD</div>
    </div>
    <div class="stat-card">
      <h3>Commandes valid√©es</h3>
      <div class="value" id="confirmedOrders">0</div>
    </div>
    <button class="action-btn" onclick="downloadSalesFile()">üìÅ Fichiers vente (un) .txt</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">En Attente</button>
    <button class="tab-btn" data-tab="confirmed">Valid√©es</button>
    <button class="tab-btn" data-tab="menu">Ajouter/Supprimer</button>
  </div>

  <div id="pendingTab">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher une commande..." />
    </div>
    <div class="orders-container" id="pendingOrders">
      <p style="text-align:center; color:#777;">Aucune commande.</p>
    </div>
  </div>

  <div id="confirmedTab" class="hidden">
    <div class="search-bar">
      <input type="text" id="searchInputConfirmed" placeholder="Rechercher une commande..." />
    </div>
    <div class="orders-container" id="confirmedOrdersList">
      <p style="text-align:center; color:#777;">Aucune commande valid√©e.</p>
    </div>
  </div>

  <div id="menuTab" class="hidden">
    <div class="menu-inputs">
      <input type="text" id="dishName" placeholder="Nom du plat" />
      <textarea id="dishDesc" placeholder="Description"></textarea>
      <input type="text" id="dishPrice" placeholder="Prix (ex: 45 MAD)" />
      <input type="text" id="dishCategory" placeholder="Cat√©gorie (ex: Plats principaux)" />
      <div class="url-input">
        <label>URL de l'image (facultatif)</label>
        <input type="text" id="dishImageUrl" placeholder="https://res.cloudinary.com/..." />
      </div>
      <button class="add-btn" onclick="addDish()">Ajouter au menu</button>
    </div>
    <h3 style="margin-top: 24px; margin-bottom: 12px;">Plats du menu</h3>
    <div class="menu-list-container" id="menuList">
      <p>Chargement...</p>
    </div>
  </div>

  <!-- Notification sonore -->
  <audio id="notificationSound" preload="auto">
    <source src="https://notificationsounds.com/storage/sounds/file-sounds-1312-notification.mp3" type="audio/mpeg">
  </audio>

  <!-- Notification visuelle -->
  <div id="notificationToast"></div>

  <script>
    // ‚úÖ CORRIG√â : suppression des espaces
    const BASE_URL = 'https://backend-menu-cloudinary-production.up.railway.app';
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      document.body.innerHTML = '<p style="text-align:center;margin-top:40px;color:red;">Acc√®s refus√©.</p>';
    }

    let allPendingOrders = [];
    let allConfirmedOrders = [];
    let lastOrderCount = 0;
    let pollingInterval = null;

    // Notification
    function showNotification(message) {
      const toast = document.getElementById('notificationToast');
      const audio = document.getElementById('notificationSound');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 4000);
      if (!document.hidden) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Son bloqu√© :", e));
      }
    }

    // Stats
    function loadStats() {
      fetch(`${BASE_URL}/api/stats/today/${token}`)
        .then(r => r.json())
        .then(data => {
          document.getElementById('todaySales').textContent = `${data.total_sales} MAD`;
          document.getElementById('confirmedOrders').textContent = data.orders_count;
        })
        .catch(console.error);
    }

    function loadPendingOrders() {
      fetch(`${BASE_URL}/api/orders/pending/${token}`)
        .then(r => r.json())
        .then(orders => {
          allPendingOrders = orders;
          renderOrders(orders, 'pending');
          if (lastOrderCount > 0 && orders.length > lastOrderCount) {
            const diff = orders.length - lastOrderCount;
            showNotification(`üîî ${diff} nouvelle${diff > 1 ? 's' : ''} commande${diff > 1 ? 's' : ''} !`);
          }
          lastOrderCount = orders.length;
        })
        .catch(console.error);
    }

    function loadConfirmedOrders() {
      fetch(`${BASE_URL}/api/orders/confirmed/${token}`)
        .then(r => r.json())
        .then(orders => {
          allConfirmedOrders = orders;
          renderOrders(orders, 'confirmed');
        })
        .catch(console.error);
    }

    // ‚úÖ Charger et afficher les plats
    function loadMenuItems() {
      fetch(`${BASE_URL}/api/menu/${token}`)
        .then(r => r.json())
        .then(dishes => {
          const container = document.getElementById('menuList');
          if (dishes.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#777;">Aucun plat ajout√©.</p>';
            return;
          }
          container.innerHTML = dishes.map(d => `
            <div class="menu-item-card">
              <div class="menu-item-header">
                <span>${d.name} ‚Ä¢ ${d.price}</span>
                <button class="btn btn-delete" onclick="deleteDish(${d.id})">Supprimer</button>
              </div>
              <p>${d.description || ''} ‚Ä¢ ${d.category}</p>
              ${d.image_url ? `<img src="${d.image_url}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;margin-top:8px;">` : ''}
            </div>
          `).join('');
        })
        .catch(() => {
          document.getElementById('menuList').innerHTML = '<p style="color:red;">Erreur de chargement du menu.</p>';
        });
    }

    function renderOrders(orders, tab) {
      const container = document.getElementById(tab === 'pending' ? 'pendingOrders' : 'confirmedOrdersList');
      if (orders.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#777;">Aucune commande.</p>';
        return;
      }
      container.innerHTML = orders.map(o => `
        <div class="order" data-id="${o.id}">
          <div class="order-header">
            <!-- ‚úÖ Affiche "Table N" si fourni -->
            <span>Commande #${o.id} ‚Ä¢ ${o.table_number && o.table_number.toLowerCase().includes('table') ? o.table_number : (o.table_number || '√Ä emporter')}</span>
            <span>${new Date(o.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
          </div>
          <div class="order-items">
            ${o.items.map(i => `<div class="order-item">‚Ä¢ ${i.dish.name} x${i.quantity}</div>`).join('')}
          </div>
          <div class="actions">
            <button class="btn btn-confirm" onclick="confirmOrder(${o.id})">${tab === 'pending' ? 'Valider' : 'Annuler'}</button>
            <button class="btn btn-delete" onclick="deleteOrder(${o.id})">Annuler</button>
          </div>
        </div>
      `).join('');
    }

    // Recherche
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allPendingOrders.filter(o =>
        o.id.toString().includes(term) ||
        (o.table_number && o.table_number.toLowerCase().includes(term)) ||
        o.items.some(i => i.dish.name.toLowerCase().includes(term))
      );
      renderOrders(filtered, 'pending');
    });

    document.getElementById('searchInputConfirmed').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allConfirmedOrders.filter(o =>
        o.id.toString().includes(term) ||
        (o.table_number && o.table_number.toLowerCase().includes(term)) ||
        o.items.some(i => i.dish.name.toLowerCase().includes(term))
      );
      renderOrders(filtered, 'confirmed');
    });

    // Actions commandes
    function confirmOrder(id) {
      fetch(`${BASE_URL}/api/order/${id}/confirm`, { method: 'POST' })
        .then(() => {
          loadStats();
          loadPendingOrders();
          loadConfirmedOrders();
        })
        .catch(console.error);
    }

    function deleteOrder(id) {
      if (confirm("Supprimer cette commande ?")) {
        fetch(`${BASE_URL}/api/order/${id}`, { method: 'DELETE' })
          .then(() => {
            loadStats();
            loadPendingOrders();
            loadConfirmedOrders();
          })
          .catch(console.error);
      }
    }

    // ‚úÖ Supprimer un plat
    function deleteDish(dishId) {
      if (confirm("Supprimer ce plat du menu ?")) {
        fetch(`${BASE_URL}/api/menu/${dishId}`, { method: 'DELETE' })
          .then(() => loadMenuItems())
          .catch(console.error);
      }
    }

    // Onglets
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('pendingTab').classList.toggle('hidden', btn.dataset.tab !== 'pending');
        document.getElementById('confirmedTab').classList.toggle('hidden', btn.dataset.tab !== 'confirmed');
        document.getElementById('menuTab').classList.toggle('hidden', btn.dataset.tab !== 'menu');
        if (btn.dataset.tab === 'pending') loadPendingOrders();
        if (btn.dataset.tab === 'confirmed') loadConfirmedOrders();
        if (btn.dataset.tab === 'menu') loadMenuItems();
      });
    });

    // Ajout de plat
    async function addDish() {
      const name = document.getElementById('dishName').value.trim();
      const desc = document.getElementById('dishDesc').value.trim();
      const price = document.getElementById('dishPrice').value.trim();
      const category = document.getElementById('dishCategory').value.trim();
      const imageUrl = document.getElementById('dishImageUrl').value.trim();

      if (!name || !desc || !price || !category) {
        alert("Tous les champs sont requis.");
        return;
      }

      fetch(`${BASE_URL}/api/menu/add/${token}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          description: desc,
          price,
          category,
          image_url: imageUrl || null
        })
      })
      .then(res => {
        if (res.ok) {
          alert('Plat ajout√© !');
          document.getElementById('dishName').value = '';
          document.getElementById('dishDesc').value = '';
          document.getElementById('dishPrice').value = '';
          document.getElementById('dishCategory').value = '';
          document.getElementById('dishImageUrl').value = '';
          loadMenuItems(); // ‚úÖ Rafra√Æchit la liste
        } else {
          alert('Erreur lors de l‚Äôajout.');
        }
      })
      .catch(console.error);
    }

    // T√©l√©chargement
    function downloadSalesFile() {
      fetch(`${BASE_URL}/api/orders/confirmed/${token}`)
        .then(r => r.json())
        .then(orders => {
          const content = orders.map(o => {
            const total = o.items.reduce((sum, i) => sum + i.dish.price * i.quantity, 0);
            return `Commande #${o.id} - ${o.table_number || '√Ä emporter'}\n${o.items.map(i => `  ‚Ä¢ ${i.dish.name} x${i.quantity}`).join('\n')}\nTotal: ${total} MAD\n---`;
          }).join('\n\n');

          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ventes_${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
        })
        .catch(console.error);
    }

    // D√©marrer le polling
    function startPolling() {
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(() => {
        loadStats();
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        if (activeTab === 'pending') {
          loadPendingOrders();
        } else if (activeTab === 'confirmed') {
          loadConfirmedOrders();
        }
      }, 5000);
    }

    // Chargement initial
    loadStats();
    loadPendingOrders();
    loadConfirmedOrders();
    startPolling();
  </script>
</body>
</html>